name: Frontend CI/CD

on:
  push:
    branches:
      - main
      - dev
      - experimental
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-cicd.yml'
  pull_request:
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-cicd.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io/${{ github.repository_owner }}
  IMAGE_NAME: infinity-frontend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || github.ref == 'refs/heads/dev' && 'staging' || 'experimental' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for build version generation

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci --legacy-peer-deps

      - name: Resolve build environment
        id: env
        run: |
          set -euo pipefail
          echo "api=${{ secrets.FRONTEND_API_BASE_URL }}" >> "$GITHUB_OUTPUT"
          echo "image=${{ secrets.FRONTEND_IMAGE_BASE_URL }}" >> "$GITHUB_OUTPUT"
          echo "token=${{ secrets.FRONTEND_STRAPI_TOKEN }}" >> "$GITHUB_OUTPUT"
          echo "site=${{ secrets.SITE_URL }}" >> "$GITHUB_OUTPUT"

      - name: Select Dockerfile and image tag
        id: meta
        run: |
          set -euo pipefail
          case "${GITHUB_REF_NAME}" in
            dev)
              DOCKERFILE="frontend/dev.Dockerfile"
              RUNTIME_TAG="dev"
              ;;
            experimental)
              DOCKERFILE="frontend/main.Dockerfile"
              RUNTIME_TAG="experimental"
              ;;
            *)
              DOCKERFILE="frontend/main.Dockerfile"
              RUNTIME_TAG="main"
              ;;
          esac

          echo "dockerfile=${DOCKERFILE}" >> "$GITHUB_OUTPUT"
          echo "runtime_tag=${RUNTIME_TAG}" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and push Docker image
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_API_BASE_URL="${{ steps.env.outputs.api }}" \
            --build-arg NEXT_PUBLIC_IMAGE_BASE_URL="${{ steps.env.outputs.image }}" \
            --build-arg NEXT_PUBLIC_STRAPI_TOKEN="${{ steps.env.outputs.token }}" \
            --build-arg NEXT_PUBLIC_SITE_URL="${{ steps.env.outputs.site }}" \
            --build-arg GITHUB_SHA="${{ github.sha }}" \
            -f ${{ steps.meta.outputs.dockerfile }} \
            -t $REGISTRY/$IMAGE_NAME:${{ github.sha }} \
            frontend
          docker tag $REGISTRY/$IMAGE_NAME:${{ github.sha }} $REGISTRY/$IMAGE_NAME:${{ steps.meta.outputs.runtime_tag }}
          docker push $REGISTRY/$IMAGE_NAME:${{ github.sha }}
          docker push $REGISTRY/$IMAGE_NAME:${{ steps.meta.outputs.runtime_tag }}

      - name: Upload docker-compose (prod)
        if: github.ref == 'refs/heads/main'
        uses: appleboy/scp-action@v0.1.1
        with:
          host: ${{ secrets.FRONTEND_HOST }}
          username: ${{ secrets.FRONTEND_USER }}
          key: ${{ secrets.FRONTEND_SSH_KEY }}
          port: ${{ secrets.FRONTEND_PORT || '22' }}
          source: frontend/docker-compose.yml
          target: /opt/infinity/frontend/

      - name: Deploy to production
        if: github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.FRONTEND_HOST }}
          username: ${{ secrets.FRONTEND_USER }}
          key: ${{ secrets.FRONTEND_SSH_KEY }}
          port: ${{ secrets.FRONTEND_PORT || '22' }}
          script: |
            set -euo pipefail
            cd /opt/infinity/frontend
            echo "${{ secrets.GHCR_DEPLOY_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_DEPLOY_USER }} --password-stdin
            cat <<-'EOF' > main.env
            ${{ secrets.FRONTEND_ENV_FILE }}
            EOF
            export IMAGE_TAG=main
            export ENV_FILE=main.env
            docker compose pull
            docker compose up -d --remove-orphans
            if ! docker image prune -f; then
              echo "Skipped prune: another operation is already running."
            fi

      - name: Upload docker-compose (staging)
        if: github.ref == 'refs/heads/dev'
        uses: appleboy/scp-action@v0.1.1
        with:
          host: ${{ secrets.FRONTEND_HOST }}
          username: ${{ secrets.FRONTEND_USER }}
          key: ${{ secrets.FRONTEND_SSH_KEY }}
          port: ${{ secrets.FRONTEND_PORT || '22' }}
          source: frontend/docker-compose.yml
          target: /opt/infinity/frontend/

      - name: Deploy to staging
        if: github.ref == 'refs/heads/dev'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.FRONTEND_HOST }}
          username: ${{ secrets.FRONTEND_USER }}
          key: ${{ secrets.FRONTEND_SSH_KEY }}
          port: ${{ secrets.FRONTEND_PORT || '22' }}
          script: |
            set -euo pipefail
            cd /opt/infinity/frontend
            echo "${{ secrets.GHCR_DEPLOY_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_DEPLOY_USER }} --password-stdin
            cat <<-'EOF' > dev.env
            ${{ secrets.FRONTEND_ENV_FILE }}
            EOF
            export IMAGE_TAG=dev
            export ENV_FILE=dev.env
            docker compose pull
            docker compose up -d --remove-orphans
            if ! docker image prune -f; then
              echo "Skipped prune: another operation is already running."
            fi

      - name: Upload docker-compose (experimental)
        if: github.ref == 'refs/heads/experimental'
        uses: appleboy/scp-action@v0.1.1
        with:
          host: ${{ secrets.FRONTEND_HOST }}
          username: ${{ secrets.FRONTEND_USER }}
          key: ${{ secrets.FRONTEND_SSH_KEY }}
          port: ${{ secrets.FRONTEND_PORT || '22' }}
          source: frontend/docker-compose.yml
          target: /opt/infinity/frontend/

      - name: Deploy to experimental
        if: github.ref == 'refs/heads/experimental'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.FRONTEND_HOST }}
          username: ${{ secrets.FRONTEND_USER }}
          key: ${{ secrets.FRONTEND_SSH_KEY }}
          port: ${{ secrets.FRONTEND_PORT || '22' }}
          script: |
            set -euo pipefail
            cd /opt/infinity/frontend
            echo "${{ secrets.GHCR_DEPLOY_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_DEPLOY_USER }} --password-stdin
            cat <<-'EOF' > main.env
            ${{ secrets.FRONTEND_ENV_FILE }}
            EOF
            export IMAGE_TAG=experimental
            export ENV_FILE=main.env
            docker compose pull
            docker compose up -d --remove-orphans
            if ! docker image prune -f; then
              echo "Skipped prune: another operation is already running."
            fi

