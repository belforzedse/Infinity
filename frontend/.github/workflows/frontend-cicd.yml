name: Frontend CI/CD

on:
  push:
    branches:
      - main
      - dev
      - experimental
  workflow_dispatch:

env:
  REGISTRY: ghcr.io/${{ github.repository_owner }}
  IMAGE_NAME: infinity-frontend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Resolve build environment
        id: env
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF_NAME}" == "dev" ]]; then
            echo "api=${{ secrets.STAGING_FRONTEND_API_BASE_URL }}" >> "$GITHUB_OUTPUT"
            echo "image=${{ secrets.STAGING_FRONTEND_IMAGE_BASE_URL }}" >> "$GITHUB_OUTPUT"
            echo "token=${{ secrets.STAGING_FRONTEND_STRAPI_TOKEN }}" >> "$GITHUB_OUTPUT"
          elif [[ "${GITHUB_REF_NAME}" == "experimental" ]]; then
            echo "api=${{ secrets.EXPERIMENTAL_FRONTEND_API_BASE_URL }}" >> "$GITHUB_OUTPUT"
            echo "image=${{ secrets.EXPERIMENTAL_FRONTEND_IMAGE_BASE_URL }}" >> "$GITHUB_OUTPUT"
            echo "token=${{ secrets.EXPERIMENTAL_FRONTEND_STRAPI_TOKEN }}" >> "$GITHUB_OUTPUT"
          else
            echo "api=${{ secrets.PROD_FRONTEND_API_BASE_URL }}" >> "$GITHUB_OUTPUT"
            echo "image=${{ secrets.PROD_FRONTEND_IMAGE_BASE_URL }}" >> "$GITHUB_OUTPUT"
            echo "token=${{ secrets.PROD_FRONTEND_STRAPI_TOKEN }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Select Dockerfile and image tag
        id: meta
        run: |
          set -euo pipefail
          case "${GITHUB_REF_NAME}" in
            dev)
              DOCKERFILE="dev.Dockerfile"
              RUNTIME_TAG="dev"
              ;;
            experimental)
              DOCKERFILE="main.Dockerfile"
              RUNTIME_TAG="experimental"
              ;;
            *)
              DOCKERFILE="main.Dockerfile"
              RUNTIME_TAG="main"
              ;;
          esac

          echo "dockerfile=${DOCKERFILE}" >> "$GITHUB_OUTPUT"
          echo "runtime_tag=${RUNTIME_TAG}" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and push Docker image
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_API_BASE_URL="${{ steps.env.outputs.api }}" \
            --build-arg NEXT_PUBLIC_IMAGE_BASE_URL="${{ steps.env.outputs.image }}" \
            --build-arg NEXT_PUBLIC_STRAPI_TOKEN="${{ steps.env.outputs.token }}" \
            -f ${{ steps.meta.outputs.dockerfile }} \
            -t $REGISTRY/$IMAGE_NAME:${{ github.sha }} .
          docker tag $REGISTRY/$IMAGE_NAME:${{ github.sha }} $REGISTRY/$IMAGE_NAME:${{ steps.meta.outputs.runtime_tag }}
          docker push $REGISTRY/$IMAGE_NAME:${{ github.sha }}
          docker push $REGISTRY/$IMAGE_NAME:${{ steps.meta.outputs.runtime_tag }}

      - name: Upload docker-compose (prod)
        if: github.ref == 'refs/heads/main'
        uses: appleboy/scp-action@v0.1.1
        with:
          host: ${{ secrets.PROD_FRONTEND_HOST }}
          username: ${{ secrets.PROD_FRONTEND_USER }}
          key: ${{ secrets.PROD_FRONTEND_SSH_KEY }}
          port: ${{ secrets.PROD_FRONTEND_PORT || '22' }}
          source: docker-compose.yml
          target: /opt/infinity/frontend/

      - name: Deploy to production
        if: github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PROD_FRONTEND_HOST }}
          username: ${{ secrets.PROD_FRONTEND_USER }}
          key: ${{ secrets.PROD_FRONTEND_SSH_KEY }}
          port: ${{ secrets.PROD_FRONTEND_PORT || '22' }}
          script: |
            set -euo pipefail
            cd /opt/infinity/frontend
            echo "${{ secrets.GHCR_DEPLOY_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_DEPLOY_USER }} --password-stdin
            cat <<EOF > main.env
            NODE_ENV=production
            PORT=3000
            NEXT_PUBLIC_API_BASE_URL=${{ secrets.PROD_FRONTEND_API_BASE_URL }}
            NEXT_PUBLIC_IMAGE_BASE_URL=${{ secrets.PROD_FRONTEND_IMAGE_BASE_URL }}
            NEXT_PUBLIC_STRAPI_TOKEN=${{ secrets.PROD_FRONTEND_STRAPI_TOKEN }}
            EOF
            export IMAGE_TAG=main
            export ENV_FILE=main.env
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f

      - name: Upload docker-compose (staging)
        if: github.ref == 'refs/heads/dev'
        uses: appleboy/scp-action@v0.1.1
        with:
          host: ${{ secrets.STAGING_FRONTEND_HOST }}
          username: ${{ secrets.STAGING_FRONTEND_USER }}
          key: ${{ secrets.STAGING_FRONTEND_SSH_KEY }}
          port: ${{ secrets.STAGING_FRONTEND_PORT || '22' }}
          source: docker-compose.yml
          target: /opt/infinity/frontend/

      - name: Deploy to staging
        if: github.ref == 'refs/heads/dev'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.STAGING_FRONTEND_HOST }}
          username: ${{ secrets.STAGING_FRONTEND_USER }}
          key: ${{ secrets.STAGING_FRONTEND_SSH_KEY }}
          port: ${{ secrets.STAGING_FRONTEND_PORT || '22' }}
          script: |
            set -euo pipefail
            cd /opt/infinity/frontend
            echo "${{ secrets.GHCR_DEPLOY_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_DEPLOY_USER }} --password-stdin
            cat <<EOF > dev.env
            NODE_ENV=production
            PORT=3000
            NEXT_PUBLIC_API_BASE_URL=${{ secrets.STAGING_FRONTEND_API_BASE_URL }}
            NEXT_PUBLIC_IMAGE_BASE_URL=${{ secrets.STAGING_FRONTEND_IMAGE_BASE_URL }}
            NEXT_PUBLIC_STRAPI_TOKEN=${{ secrets.STAGING_FRONTEND_STRAPI_TOKEN }}
            EOF
            export IMAGE_TAG=dev
            export ENV_FILE=dev.env
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f

      - name: Upload docker-compose (experimental)
        if: github.ref == 'refs/heads/experimental'
        uses: appleboy/scp-action@v0.1.1
        with:
          host: ${{ secrets.EXPERIMENTAL_FRONTEND_HOST }}
          username: ${{ secrets.EXPERIMENTAL_FRONTEND_USER }}
          key: ${{ secrets.EXPERIMENTAL_FRONTEND_SSH_KEY }}
          port: ${{ secrets.EXPERIMENTAL_FRONTEND_PORT || '22' }}
          source: docker-compose.yml
          target: /opt/infinity/frontend/

      - name: Deploy to experimental
        if: github.ref == 'refs/heads/experimental'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EXPERIMENTAL_FRONTEND_HOST }}
          username: ${{ secrets.EXPERIMENTAL_FRONTEND_USER }}
          key: ${{ secrets.EXPERIMENTAL_FRONTEND_SSH_KEY }}
          port: ${{ secrets.EXPERIMENTAL_FRONTEND_PORT || '22' }}
          script: |
            set -euo pipefail
            cd /opt/infinity/frontend
            echo "${{ secrets.GHCR_DEPLOY_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_DEPLOY_USER }} --password-stdin
            cat <<EOF > main.env
            NODE_ENV=production
            PORT=3000
            NEXT_PUBLIC_API_BASE_URL=${{ secrets.EXPERIMENTAL_FRONTEND_API_BASE_URL }}
            NEXT_PUBLIC_IMAGE_BASE_URL=${{ secrets.EXPERIMENTAL_FRONTEND_IMAGE_BASE_URL }}
            NEXT_PUBLIC_STRAPI_TOKEN=${{ secrets.EXPERIMENTAL_FRONTEND_STRAPI_TOKEN }}
            EOF
            export IMAGE_TAG=experimental
            export ENV_FILE=main.env
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f
