---
description: HTTP/2 configuration guide for performance optimization
globs: devops/**/*.conf,devops/**/*.nginx,devops/**/*.apache
---

# HTTP/2 Configuration for Performance Optimization

## Overview

HTTP/2 provides significant performance improvements over HTTP/1.1, including:
- Multiplexing: Multiple requests over a single connection
- Server push: Proactive resource delivery
- Header compression: Reduced overhead
- Binary protocol: More efficient parsing

**Expected Lighthouse improvement**: ~2,140ms savings (91 requests not served via HTTP/2)

## Nginx Configuration

### Basic HTTP/2 Setup

```nginx
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    
    server_name staging.infinitycolor.org;
    
    # SSL configuration
    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;
    
    # HTTP/2 specific optimizations
    http2_max_field_size 16k;
    http2_max_header_size 32k;
    http2_max_concurrent_streams 100;
    
    # Enable HTTP/2 Server Push for critical resources
    location = / {
        http2_push /fonts/peyda-regular-fanum.woff2;
        http2_push /styles/main.css;
    }
    
    # Static assets with long cache
    location ~* \.(woff2|woff|ttf|eot|svg|jpg|jpeg|png|gif|ico|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### HTTP/2 Server Push (Optional)

Server push allows proactive delivery of critical resources:

```nginx
location = / {
    http2_push /fonts/peyda-regular-fanum.woff2;
    http2_push /_next/static/css/main.css;
    http2_push_preload on;
}
```

**Note**: Use server push judiciously - only for resources that are definitely needed and not already cached.

## Apache Configuration

### Enable HTTP/2 Module

```bash
# Enable required modules
a2enmod http2
a2enmod ssl
a2enmod headers
```

### Virtual Host Configuration

```apache
<VirtualHost *:443>
    ServerName staging.infinitycolor.org
    
    # Enable HTTP/2
    Protocols h2 http/1.1
    
    # SSL configuration
    SSLEngine on
    SSLCertificateFile /path/to/certificate.crt
    SSLCertificateKeyFile /path/to/private.key
    
    # HTTP/2 optimizations
    H2Direct on
    H2Push on
    H2PushPriority * After 16
    H2PushPriority text/css Before
    H2PushPriority image/jpeg After 32
    H2PushPriority application/javascript Interleaved 256
    
    # Static assets
    <LocationMatch "\.(woff2|woff|ttf|eot|svg|jpg|jpeg|png|gif|ico|css|js)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </LocationMatch>
</VirtualHost>
```

## Verification

### Check HTTP/2 Support

```bash
# Using curl
curl -I --http2 https://staging.infinitycolor.org

# Should show:
# HTTP/2 200
```

### Browser DevTools

1. Open Chrome DevTools → Network tab
2. Right-click on any request → Protocol
3. Should show "h2" for HTTP/2 requests

### Lighthouse Audit

After configuration, run Lighthouse audit:
- Should show "Use HTTP/2" as passed
- All requests should be served via HTTP/2

## Troubleshooting

### HTTP/2 Not Working

1. **Check SSL/TLS**: HTTP/2 requires HTTPS (except for localhost)
2. **Verify module enabled**: `nginx -V` or `apache2ctl -M`
3. **Check browser support**: Modern browsers support HTTP/2
4. **Review server logs**: Check for HTTP/2 related errors

### Performance Not Improved

1. **Verify all requests use HTTP/2**: Check browser DevTools
2. **Review server push**: May cause issues if overused
3. **Check connection limits**: HTTP/2 multiplexing helps with many small requests
4. **Monitor server resources**: HTTP/2 uses more server memory

## Best Practices

1. **Always use HTTPS**: HTTP/2 requires encrypted connections
2. **Optimize critical resources**: Use server push only for above-the-fold resources
3. **Monitor performance**: Track Core Web Vitals before/after
4. **Test thoroughly**: Verify functionality across browsers
5. **Update certificates**: Ensure SSL certificates are valid and up-to-date

## References

- [Nginx HTTP/2 Module](https://nginx.org/en/docs/http/ngx_http_v2_module.html)
- [Apache HTTP/2 Guide](https://httpd.apache.org/docs/2.4/howto/http2.html)
- [HTTP/2 Specification](https://httpwg.org/specs/rfc7540.html)
