name: Backend CI/CD

on:
  push:
    branches:
      - main
      - dev
      - experimental
  workflow_dispatch:

env:
  REGISTRY: ghcr.io/${{ github.repository_owner }}
  IMAGE_NAME: infinity-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Dockerfile and image tag
        id: meta
        run: |
          set -euo pipefail
          case "${GITHUB_REF_NAME}" in
            dev)
              echo "dockerfile=dev.Dockerfile" >> "$GITHUB_OUTPUT"
              echo "runtime_tag=dev" >> "$GITHUB_OUTPUT"
              ;;
            experimental)
              echo "dockerfile=main.Dockerfile" >> "$GITHUB_OUTPUT"
              echo "runtime_tag=experimental" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "dockerfile=main.Dockerfile" >> "$GITHUB_OUTPUT"
              echo "runtime_tag=main" >> "$GITHUB_OUTPUT"
              ;;
          esac

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and push Docker image
        run: |
          docker build -f ${{ steps.meta.outputs.dockerfile }} -t $REGISTRY/$IMAGE_NAME:${{ github.sha }} .
          docker tag $REGISTRY/$IMAGE_NAME:${{ github.sha }} $REGISTRY/$IMAGE_NAME:${{ steps.meta.outputs.runtime_tag }}
          docker push $REGISTRY/$IMAGE_NAME:${{ github.sha }}
          docker push $REGISTRY/$IMAGE_NAME:${{ steps.meta.outputs.runtime_tag }}

      - name: Upload docker-compose (prod)
        if: github.ref == 'refs/heads/main'
        uses: appleboy/scp-action@v0.1.1
        with:
          host: ${{ secrets.PROD_BACKEND_HOST }}
          username: ${{ secrets.PROD_BACKEND_USER }}
          key: ${{ secrets.PROD_BACKEND_SSH_KEY }}
          port: ${{ secrets.PROD_BACKEND_PORT || '22' }}
          source: docker-compose.yml
          target: /opt/infinity/backend/

      - name: Deploy to production
        if: github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PROD_BACKEND_HOST }}
          username: ${{ secrets.PROD_BACKEND_USER }}
          key: ${{ secrets.PROD_BACKEND_SSH_KEY }}
          port: ${{ secrets.PROD_BACKEND_PORT || '22' }}
          script: |
            set -euo pipefail
            cd /opt/infinity/backend
            echo "${{ secrets.GHCR_DEPLOY_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_DEPLOY_USER }} --password-stdin
            cat <<-'EOF' > main.env
            ${{ secrets.PROD_BACKEND_ENV_FILE }}
            EOF
            export DB_ENV_FILE=db.env
            export ENV_FILE=main.env
            DB_USER=$(grep -E "^DATABASE_USERNAME=" "$ENV_FILE" | tail -1 | cut -d= -f2-)
            DB_PASS=$(grep -E "^DATABASE_PASSWORD=" "$ENV_FILE" | tail -1 | cut -d= -f2-)
            DB_NAME=$(grep -E "^DATABASE_NAME=" "$ENV_FILE" | tail -1 | cut -d= -f2-)
            cat > "$DB_ENV_FILE" <<-EOF
            POSTGRES_USER=${DB_USER}
            POSTGRES_PASSWORD=${DB_PASS}
            POSTGRES_DB=${DB_NAME}
            EOF
            export IMAGE_TAG=main
            docker compose --env-file "$ENV_FILE" pull
            docker compose --env-file "$ENV_FILE" up -d infinity-postgres infinity-redis
            docker compose --env-file "$ENV_FILE" run --rm strapi npm run strapi -- migrate
            docker compose --env-file "$ENV_FILE" up -d --remove-orphans
            docker image prune -f

      - name: Upload docker-compose (staging)
        if: github.ref == 'refs/heads/dev'
        uses: appleboy/scp-action@v0.1.1
        with:
          host: ${{ secrets.STAGING_BACKEND_HOST }}
          username: ${{ secrets.STAGING_BACKEND_USER }}
          key: ${{ secrets.STAGING_BACKEND_SSH_KEY }}
          port: ${{ secrets.STAGING_BACKEND_PORT || '22' }}
          source: docker-compose.yml
          target: /opt/infinity/backend/

      - name: Deploy to staging
        if: github.ref == 'refs/heads/dev'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.STAGING_BACKEND_HOST }}
          username: ${{ secrets.STAGING_BACKEND_USER }}
          key: ${{ secrets.STAGING_BACKEND_SSH_KEY }}
          port: ${{ secrets.STAGING_BACKEND_PORT || '22' }}
          script: |
            set -euo pipefail
            cd /opt/infinity/backend
            echo "${{ secrets.GHCR_DEPLOY_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_DEPLOY_USER }} --password-stdin
            cat <<-'EOF' > dev.env
            ${{ secrets.STAGING_BACKEND_ENV_FILE }}
            EOF
            export DB_ENV_FILE=db.env
            export ENV_FILE=dev.env
            DB_USER=$(grep -E "^DATABASE_USERNAME=" "$ENV_FILE" | tail -1 | cut -d= -f2-)
            DB_PASS=$(grep -E "^DATABASE_PASSWORD=" "$ENV_FILE" | tail -1 | cut -d= -f2-)
            DB_NAME=$(grep -E "^DATABASE_NAME=" "$ENV_FILE" | tail -1 | cut -d= -f2-)
            cat > "$DB_ENV_FILE" <<-EOF
            POSTGRES_USER=${DB_USER}
            POSTGRES_PASSWORD=${DB_PASS}
            POSTGRES_DB=${DB_NAME}
            EOF
            export IMAGE_TAG=dev
            docker compose --env-file "$ENV_FILE" pull
            docker compose --env-file "$ENV_FILE" up -d infinity-postgres infinity-redis
            docker compose --env-file "$ENV_FILE" run --rm strapi npm run strapi -- migrate
            docker compose --env-file "$ENV_FILE" up -d --remove-orphans
            docker image prune -f

      - name: Upload docker-compose (experimental)
        if: github.ref == 'refs/heads/experimental'
        uses: appleboy/scp-action@v0.1.1
        with:
          host: ${{ secrets.EXPERIMENTAL_BACKEND_HOST }}
          username: ${{ secrets.EXPERIMENTAL_BACKEND_USER }}
          key: ${{ secrets.EXPERIMENTAL_BACKEND_SSH_KEY }}
          port: ${{ secrets.EXPERIMENTAL_BACKEND_PORT || '22' }}
          source: docker-compose.yml
          target: /opt/infinity/backend/

      - name: Deploy to experimental
        if: github.ref == 'refs/heads/experimental'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EXPERIMENTAL_BACKEND_HOST }}
          username: ${{ secrets.EXPERIMENTAL_BACKEND_USER }}
          key: ${{ secrets.EXPERIMENTAL_BACKEND_SSH_KEY }}
          port: ${{ secrets.EXPERIMENTAL_BACKEND_PORT || '22' }}
          script: |
            set -euo pipefail
            cd /opt/infinity/backend
            echo "${{ secrets.GHCR_DEPLOY_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_DEPLOY_USER }} --password-stdin
            cat <<-'EOF' > main.env
            ${{ secrets.EXPERIMENTAL_BACKEND_ENV_FILE }}
            EOF
            export DB_ENV_FILE=db.env
            export ENV_FILE=main.env
            DB_USER=$(grep -E "^DATABASE_USERNAME=" "$ENV_FILE" | tail -1 | cut -d= -f2-)
            DB_PASS=$(grep -E "^DATABASE_PASSWORD=" "$ENV_FILE" | tail -1 | cut -d= -f2-)
            DB_NAME=$(grep -E "^DATABASE_NAME=" "$ENV_FILE" | tail -1 | cut -d= -f2-)
            cat > "$DB_ENV_FILE" <<-EOF
            POSTGRES_USER=${DB_USER}
            POSTGRES_PASSWORD=${DB_PASS}
            POSTGRES_DB=${DB_NAME}
            EOF
            export IMAGE_TAG=experimental
            docker compose --env-file "$ENV_FILE" pull
            docker compose --env-file "$ENV_FILE" up -d infinity-postgres infinity-redis
            docker compose --env-file "$ENV_FILE" run --rm strapi npm run strapi -- migrate
            docker compose --env-file "$ENV_FILE" up -d --remove-orphans
            docker image prune -f
