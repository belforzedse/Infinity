‫فروش اقساطی پذیرندگان آنالین‬
‫اسنپ‬
‫مستندات ‪REST API‬‬

‫ویرایش ‪1.9‬‬
‫آخرین تغییرات‪01-09-2024 :‬‬

Snapp! Pay

‫اطالعات بروزرسانی مستند‬
‫توضیحات‬

‫تاریخ‬

‫شماره ویرایش‬

‫ایجاد سند‬

13th February 2022

1.0

‫ از روند خرید‬callback ‫حذف پارامتر‬

5th March 2022
:3
1.1

get ‫ و‬merchant eligibility ‫های‬API ‫بروزرسانی‬

16th April 2022

1.2

get payment token API ‫بروزرسانی‬

1st May 2022

1.3

Get Payment Status API

8th May 2022

1.4

Cancel API

14th May 2022

1.5

Update API

16th May 2022

1.6

get payment token and update APIs ‫بروزرسانی‬

20th September 2022

1.7

Get Payment Status ‫بروز رسانی سرویس‬

8th January 2023

1.8

‫ به همراه افزودن‬api ‫افزودن جزئیات به توضیحات هر‬

1st September 2024

1.9

payment token

cartItems ‫ و‬totalAmount ‫ و‬cartList ‫(تغییر پارامترهای‬

)‫به اجباری‬

‫ و‬externalSourceAmount ‫(افزودن پارامترهای‬
)commissionType

)amount ‫(اضافه کردن پارامتر‬

‫بخش سواالت متداول‬

‫فهرست‬
‫مقدمه‬

‫​‪4‬‬

‫قالب کلی پاسخ درخواست ها‬

‫​‪5‬‬

‫مکانیزم امن سازی درخواست‌ها‬

‫​‪6‬‬

‫درخواست بررسی امکان پرداخت اقساطی برای پذیرنده‬

‫​‪8‬‬

‫روند کلی پرداخت اقساطی اسنپ‌پی‬

‫​‪9‬‬

‫درخواست دریافت ‪Payment token‬‬

‫​‪12‬‬

‫درخواست ‪Verify‬‬

‫​‪16‬‬

‫درخواست ‪Settle‬‬

‫​‪18‬‬

‫درخواست ‪Revert‬‬

‫​‪19‬‬

‫درخواست ‪Get Payment Status‬‬

‫​‪20‬‬

‫درخواست ‪Cancel‬‬

‫​‪21‬‬

‫درخواست ‪Update‬‬

‫​‪22‬‬

‫سواالت متداول در پیاده سازی‬

‫​‪25‬‬

‫مقدمه‬
‫خرید اقساطی اسنپ یک راهکار پرداخت اعتباری است که توسط گروه اسنپ‌پی فراهم شده تا امکان خرید با‬
‫بازپرداخت اقساطی را در اختیار کاربران اسنپ که حساب اعتباری اسنپ‌پی خود را فعال نموده‌اند قرار دهد‪ .‬شما‬
‫به عنوان یک پذیرنده و ارائه دهندٔه خدمات می‌توانید با فراهم نمودن این روش پرداخت برای کاربران خود به‬
‫آنها اجازه دهید بدون نیاز به پرداخت تمام مبلغ‪ ،‬خرید کنند‪ .‬آن‌ها صرفا ً مبلغی به عنوان قسط اول پرداخت‬
‫‌‬
‫خواهند کرد و الباقی بدهی خود را طی چند قسط در ماه های آتی پرداخت خواهند کرد‪.‬‬
‫این راهکار‪ ،‬به دلیل افزایش قدرت خرید لحظه‌ای کاربران‪ ،‬در افزایش نرخ فروش شما تاثیر خواهد داشت‪.‬‬

‫قالب کلی پاسخ درخواست ها‬
‫در هر فراخوانی ‪ API‬موفق (‪ )2xx HTTP status codes‬این سیستم بدنه پاسخ بصورت یک شئ ‪ JSON‬و در‬
‫قالب ذیل خواهد بود‪:‬‬
‫{‬

‫‪"successful": true,‬‬
‫{ ‪"response":‬‬
‫‪"y": "x",‬‬
‫‪"z": 0‬‬
‫}‬

‫​‬

‫​‬
‫​‬

‫​‬

‫​‬

‫}‬

‫و هر فراخوانی با پاسخ ناموفق (‪ )4xx and 5xx HTTP status codes‬با بدنه پاسخ زیر همراه خواهد شد‪:‬‬

‫{ ‪"errorData":‬‬

‫‪"errorCode": 400,‬‬
‫‪"message": "",‬‬
‫‪"data": null‬‬
‫‪},‬‬

‫‪"successful": false‬‬

‫{‬
‫​‬

‫​‬

‫​‬
‫​‬

‫​‬
‫​‬

‫}‬

‫مکانیزم امن سازی درخواست‌ها‬
‫در فراخوانی هریک از سرویس های ارائه شده در این مستند ضروری است که درخواست ارسالی شامل یک توکن‬
‫ الزم به ذکر است که برای‬.‫ ذیل میسر شده‬API ‫ باشد که ایجاد این توکن از طریق فراخوانی‬JWT ‫امنیتی از جنس‬
whitelist ‫ ماشین فراخوانی کننده از قبل توسط اسنپ‌پی‬IP ‫ میبایست‬API ‫فراخوانی هر سرویس از جمله همین‬
.‫شده باشد و درخواست های متفرقه و با منبع ناشناخته پردازش نخواهند شد‬

POST: /api/online/v1/oauth/token
:)curl(‫نمونه درخواست‬
curl --location --request POST 'https://{url}/api/online/v1/oauth/token' \​
--header 'Authorization: Basic base64_encode({client_id} ':' {client_secret} )' \​
--header 'Content-Type: application/x-www-form-urlencoded' \​
--data-urlencode 'grant_type=password' \​
--data-urlencode 'scope=online-merchant' \​
--data-urlencode 'username={username}' \​
--data-urlencode 'password={password}'

:‫نمونه پاسخ‬
{​
​

"access_token": "eyJhbGciOiJ...",​

​

"token_type": "bearer",​

​

"expires_in": 3600,​

​

"scope": "online-merchant",​

​

"iat": 1645369630,​

​

"jti": "ogYjKGgZACeJ_Qc7Jb5e7v2AWWU"​

}

‫پس از دریافت توکن ایجاد شده‪ ،‬باید آن را درون ‪ Authorization header‬هریک از درخواست‌های ارسالی خود‬
‫قرار دهید‪ .‬این توکن دارای زمان اعتبار محدودی است که پس از گذر از آستانه زمانی آن باید نسبت به دریافت‬
‫توکن جدید اقدام کنید‪.‬‬

‫درخواست بررسی امکان پرداخت اقساطی برای پذیرنده‬
‫یک پذیرنده ممکن است روش های متفاوتی برای تسویه حساب مالی پیاده سازی کند و یکی از آن‌ها روش‬
‫پرداخت اقساطی اسنپ‌پی باشد‪ .‬به عنوان یک پذیرنده الزم است با فراخوانی این سرویس و بررسی نتیجه‬
‫بازگشتی در پاسخ‪ ،‬نسبت به نمایش یا عدم نمایش گزینٔه پرداخت از طریق سرویس اقساطی اسنپ‌پی تصمیم‬
‫بگیرید‪ .‬الزم به ذکر است ممکن است این روش پرداخت به دالیل مختلف برای یک پرداخت خاص در دسترس‬
‫نباشد‪ .‬لذا فراخوانی این سرویس در روند پیاده سازی ضروری است‪.‬‬
‫این سرویس به صورت داینامیک مبالغ اقساط را محاسبه می‌کند و پاسخ می‌دهد‪ ،‬در نتیجه با هر تغییر قیمت‬
‫الزم است مجدد این سرویس صدا زده شود و محاسبه مبالغ اقساط با هیچ روش دیگری قابل پذیرش نمی‌باشد‪.‬‬

‫‪GET: /api/online/offer/v1/eligible?amount=12000‬‬
‫‪Property name‬‬

‫‪Mandatory‬‬

‫‪type‬‬

‫‪Possible values‬‬

‫‪amount‬‬

‫‪true‬‬

‫‪Query param‬‬

‫‪Currency: IRR‬‬

‫نمونه پاسخ‪:‬‬
‫​{‬
‫​{ ‪"response":‬‬
‫​‬

‫‪"eligible": true,‬‬
‫"‪"title_message": "string‬‬
‫​"‪"description": "string‬‬
‫​‪},‬‬
‫​‪"successful": true‬‬

‫}‬

‫روند کلی پرداخت اقساطی اسنپ‌پی‬
‫روند پرداخت عمال هنگامی آغاز می‌شود که پذیرنده با دریافت یک توکن ‪ JWT‬از آن در هدر تمامی ریکوئست‌های‬
‫آتی استفاده کند‪ .‬اولین قدم پس از در دست داشتن توکن ‪ ،JWT‬فراخوانی سرویس ‪ eligiblity‬و تصمیم گیری‬
‫برای نمایش و یا عدم نمایش روش پرداخت اعتباری اسنپ در سایت پذیرنده خواهد بود‪.‬‬
‫چنانچه پاسخ فراخوانی سرویس ‪ eligiblity‬برابر با مقدار ‪ true‬باشد و کاربر روش پرداخت سرویس اعتباری اسنپ‬
‫را انتخاب کند‪ ،‬در این مرحله پذیرنده ملزم می‌شود تا برای فراهم ساختن یک پرداخت جدید درخواست دریافت‬
‫توکن پرداخت با پارامترهای متناسب با خرید کاربر به سرویس اسنپ‌پی ارسال نموده و یک توکن پرداخت معتبر‬
‫برای آن دریافت کند‪.‬‬
‫نکات حائز اهمیت در مرحلٔه دریافت توکن پرداخت به این صورت است‪:‬‬
‫​●‬

‫مقداری که با عنوان ‪ transactionId‬از سمت پذیرنده ارائه می‌شود باید در سیستم پذیرنده ‪ unique‬و‬
‫یکتا باشد و به ازای هر خرید متفاوت باشد‪.‬‬

‫​●‬

‫پیمنت توکن ایجاد شده توسط سرویس اسنپ‌پی نیز به ازای هر درخواست خرید ‪ unique‬خواهد بود و‬
‫باید در مراحل بعدی روند خرید در بدنٔه درخواست ها ارسال گردد‪ .‬لذا نسبت به ذخیره‌سازی و تناظر آن با‬
‫خرید درحال انجام اقدام کنید‪.‬‬

‫​●‬

‫تراکنش آیدی باید بین ‪ 5‬تا ‪ 10‬رقم باشد‪( .‬برای موارد ‪ 10‬رقم به باال حتما از یک حرف در آن استفاده‬
‫شود)‬

‫​●‬

‫الزم به ذکر است اگر کاربر در تب‌های مختلف سبد خرید را باز داشته باشد برای هر کدام از سبدهای‬
‫خرید یک تراکنش آیدی جدید و اگر برای تمامی آن‌ها پرداخت صورت گرفته باشد‪ ،‬برای هرکدام یک ستل‬
‫جداگانه در نظر گرفته می‌شود‪ .‬بنابراین باید بعد از پرداخت‪ ،‬سبد خريد بسته شده در نظر گرفته شود‪.‬‬

‫​●‬

‫همچنین باید در بدنٔه درخواست توکن پرداخت یک آدرس بازگشت توسط پذیرنده ارسال شود که در‬
‫انتهای روال پرداخت کاربر از درگاه پرداخت اسنپ‌پی نتیجه تراکنش کاربر به صورت ‪ POST‬یک فرم با‬
‫پارامترهای متناظر با نتیجه تراکنش به آن آدرس ارسال گردد‪.‬‬

‫نکته حائز اهمیت در خصوص آدرس بازگشت‪ ،‬که در بدنٔه درخواست دریافت توکن ارسال می‌شود‪ ،‬رعایت تطابق‬
‫آن با آدرس پایه‌ای است که هنگام تعریف پذیرنده به اسنپ‌پی معرفی و ‪ whitelist‬شده است‪ .‬درخواست‌های‬
‫شامل ‪ returnURL‬که دامنه آن با دامنه تعریف شده در سرویس منطبق نباشند رد خواهند شد‪.‬‬
‫پس از فراخوانی سرویس دریافت توکن پرداخت توسط پذیرنده عالوه بر توکن فوق الذکر یک آدرس فراهم شده‬
‫که پذیرنده باید کاربر را برای آغار عملیات پرداخت به آن منتقل نموده و منتظر اعالم نتیجٔه تراکنش توسط‬
‫فراخوانی آدرس بازگشتی خود باشد‪.‬‬

‫** توجه‪ :‬در صورتی که در فضای تست (استیجینگ) اقدام به خرید تستی می‌کنید موارد زیر را رعایت فرمایید‪:‬‬
‫​‪-‬‬

‫زمانی که دکمه پرداخت را انتخاب می کنید و منتظر هستید که به درگاه منتقل شوید‪ ،‬بخش ‪ https‬لینک‬
‫درگاه را مطابق زیر اصالح کنید و ‪ s‬آن را حذف کنید‪.‬‬
‫‪https://XXXX.XX.XXXX.snappcloud.io/‬‬

‫​‪-‬‬

‫پس از وارد کردن اطالعات کارت و انتخاب دکمه پرداخت‪ ،‬در زمانی که منتظر هستید تا عملیات بانکی‬
‫انجام شود‪ ،‬مرورگر در یک پیام‪ ،‬تایید شما را برای ارسال اطالعات درخواست می‌کند‪ .‬با انتخاب دکمه‬
‫‪ send anyway‬می‌توانید فرآیند پرداخت را کامل کنید‪( .‬توجه کنید این فقط برای محیط تست هست و‬
‫کاربران شما روی پروداکشن با این پیام رو به رو نخواهند شد‪).‬‬

‫​‪-‬‬

‫ممکن است شما در هنگام ورود به درگاه بانک‪ ،‬با صفحه زیر مواجه شوید‪ .‬این صفحه مربوط به درگاه‬
‫تستی (‪ )sandbox‬می‌باشد که پاسخ درگاه را شبیه سازی می‌کند و مبلغی از موجودی حساب کسر‬
‫نمی‌شود‪ .‬در این حالت‪ ،‬در بخش اول یک شماره کارت فرضی وارد کنید و برای بقیه بخش‌ها تغییری در‬
‫مورد پیش فرض انجام ندهید (گزینه ها مانند تصویر زیر انتخاب شده باشند)‪ .‬در این صورت از درگاه‬
‫پاسخ موفق دریافت خواهید کرد و می‌توانید مطابق توضیحات ادامه مراحل پردازش سفارش را انجام‬
‫دهید‪.‬‬

‫قدم بعدی در تکمیل فرآیند خرید که باید توسط پذیرنده دنبال گردد فراخوانی سرویس های ‪( verify‬در صورت‬
‫موفق‌بودن ارائٔه محصول به کاربر) است‪ .‬این نکته را درنظر داشته باشید که چنانچه سرویس ‪ verify‬در یک بازٔه‬
‫زمانی محدود فراخوانی نشود‪ ،‬به طور اتوماتیک مبلغ واریزی کاربر به حساب وی برگردانده خواهد شد‪ .‬نکته مهم‬

‫دیگر این است که پذیرنده صرفا ً یک‌بار سرویس ‪ verify‬را فراخوانی کند (حتی اگر استثنائا ً فراخوانی آدرس بازگشتی‬
‫پذیرنده چندین بار رخ داده باشد)‪.‬‬
‫آخرین قدم در نهایی سازی یک خرید موفق‪ ،‬فراخوانی سرویس ‪ settle‬به ازای دریافت پاسخ موفق از سرویس‬
‫‪ verify‬است‪ .‬پس از فراخوانی ‪ ،settle‬خرید هم از سمت اسنپ‌پی و هم از سمت پذیرنده‪ ،‬نهایی و تمام شده‬
‫تلقی خواهد شد‪.‬‬
‫در ادامٔه سند جاری به بررسی و ارائه توضیحات هر یک از ‪ API‬های مورد استفاده در روند پرداختی که تشریح شد‬
‫خواهیم پرداخت‪.‬‬

Payment token ‫درخواست دریافت‬
‫ به ازای هر خرید باید از طریق این سرویس یک توکن پرداخت جداگانه‬،‫همانطور که در بخش قبل مطرح شد‬
.‫درخواست شود و در عملیات بعدی از این توکن استفاده شود‬

POST:/api/online/payment/v1/token
:‫نمونٔه درخواست‬
{​
"amount": 0,​
"cartList": [​
{​
"cartId": 0,​
"cartItems": [​
{​
"amount": 0,​
"category": "string",​
"count": 0,​
"id": 0,​
"name": "string",
"commissionType": 0​
}​
],​
"isShipmentIncluded": true,​
"isTaxIncluded": true,​
"shippingAmount": 0,​
"taxAmount": 0,​
"totalAmount": 0​
}​
],​
"discountAmount": 0,
"externalSourceAmount": 0,​

"mobile": "string",​
"paymentMethodTypeDto": "INSTALLMENT",​
"returnURL": "string",​
"transactionId": "string"​
}

Property name

Mandatory

Note

Possible values

amount

true

Total amount of purchase

Currency: IRR

discountAmount

true

Currency: IRR

externalSourceAmount

true

Currency: IRR

mobile

true

paymentMethodTypeDto

true

returnURL

true

User mobile number
INSTALLMENT
Snapp! Pay redirect user
to return url (should be
post)

transactionId

true

cartList

true

cartList - cardId

true

cartList -

true

cartList - isTaxIncluded

true

cartList - shippingAmount

true

Shipping amount of cart

Currency: IRR

cartList - taxAmount

true

Tax amount of cart

Currency: IRR

cartList - totalAmount

true

Total amount of cart

Currency: IRR

isShipmentIncluded

Unique id for each
transaction

Cart identifier

cartItems

true

cartItems - id

true

cartItems - amount

true

cartItems - category

true

cartItems - count

true

cartItems - name

true

cartItems - commissionType

true

Cart item identifier
Currency: IRR

1,2,3,...

1,2,3,...

:‫نمونٔه پاسخ‬
{​
"response": {​
​

"paymentToken": "string"
"paymentPageUrl": "string"​
},​
"successful": true​

}

.‫ آمده است هدایت کنید‬paymentPageUrl ‫پس از دریافت توکن باید کاربر را به صفحه ای که آدرسش در پارامتر‬

:Amount ‫نحوه محاسبه مقدار‬
1- Per each Cart List:
cart list 1: [count] * [cart item amount] + [shipment: if not include] + [tax: if not included] = [total
amount 1]
2- Per each Order:
[cart list 1 =total amount] + [cart list 2 =total amount] + ... + [cart list n =total amount] [discount amount] - [external source amount] = [order amount]

‫نحوه ارسال دسته‌بندی کمیسیون ‪:commission type‬‬
‫در صورتی که تنوع دسته‌بندی‌های محصوالت شما زیاد است‪ ،‬مطابق با عنوان دسته‌بندی‌های خود در قراردادتان‪،‬‬
‫به کمک فایل زیر الزم است کد مربوط به دسته‌بندی مربوطه را همراه هر کارت آیتم ارسال کنید‪​ .‬‬
‫** توجه‪ :‬هر نوع مسئولیت عدم تطابق دسته‌بندی ارسال شده با دسته‌بندی ذکر شده در قرارداد‪ ،‬بر عهده‬
‫پذیرنده (شما) است‪​ .‬‬
‫فایل راهنمای کد‌های دسته‌بندی کاال‌ها‬

‫درخواست ‪Verify‬‬
‫پس از تکمیل مراحل پرداخت اسنپ‌پی به دست کاربر‪ ،‬وی به آدرس بازگشتی که به همراه پارامترهای ذیل ارائه‬
‫کرده‌اید منتقل می‌شود‪ .‬پذیرنده ملزم است در صورت دریافت نتیجٔه پرداخت موفق و عدم وجود مشکل در ارائٔه‬
‫خدمات ظرف مدت محدود‪ ،‬سرویس ‪ verify‬را برای نهایی‌کردن تراکنش فراخوانی کند‪ .‬بدیهی است عدم فراخوانی‬
‫‪ verify‬منجر به بازگشت مبلغ کسر شده از حساب بانکی کاربر و تغییر وضعیت سفارش سمت اسنپ‌پی به‬
‫‪ reverted‬خواهد شد‪ .‬ضمنا ً الزم است در صورت عدم ارائه محصول به هر دلیل نسبت به فراخوانی سرویس‬
‫‪ revert‬اقدام نموده و گذر زمان جهت بازگشت یک تراکنش را به عنوان راهکار همیشگی قرار ندهید‪.‬‬
‫‪Parameter name‬‬

‫‪Possible value‬‬

‫‪Description‬‬

‫‪transactionId‬‬

‫‪xxxxxx-xxxxx‬‬

‫‪Unique identifier which is sent‬‬

‫‪state‬‬

‫‪OK/FAILED‬‬

‫‪amount‬‬

‫‪)IRR( 0‬‬

‫‪in get payment token service‬‬
‫‪OK : purchase process has‬‬
‫‪been done successfully and‬‬
‫‪needs to call verify or revert‬‬
‫‪services to finalize or revert‬‬
‫‪the transaction‬‬
‫‪FAILED : purchase process‬‬
‫‪has been failed and needs to‬‬
‫‪call revert service to revert the‬‬
‫‪transaction‬‬

‫‪Post: /api/online/payment/v1/verify‬‬
‫نمونٔه درخواست‪:‬‬

‫‪"paymentToken": "string",‬‬

‫نمونٔه پاسخ‪:‬‬

‫{‬
‫}‬

{​
"response": {​
​

"transactionId": "string"​
},​
"successful": true​

}

‫درخواست ‪Settle‬‬
‫گام بعدی پس از فراخوانی سرویس ‪ verify‬برای اتمام روند یک خرید موفق فراخوانی سرویس ‪ settle‬است‪.‬‬
‫بدیهی است پس از فراخوانی سرویس ‪ ،settle‬دیگر امکان ‪ revert‬پرداخت میسر نخواهد بود‪.‬‬

‫‪Post: /api/online/payment/v1/settle‬‬
‫نمونٔه درخواست‪:‬‬

‫‪"paymentToken": "string",‬‬

‫{‬
‫}‬

‫نمونٔه پاسخ‪:‬‬
‫​{‬
‫​{ ‪"response":‬‬
‫​‬

‫​"‪"transactionId": "string‬‬
‫​‪},‬‬
‫​‪"successful": true‬‬

‫}‬

‫درخواست ‪Revert‬‬
‫** اغلب نیازی به پیاده‌سازی این قسمت وجود ندارد‪ .‬در صورت نیاز به پیاده‌سازی این سرویس‪ ،‬تیم پشتیبانی‬
‫اسنپ‌پی به شما اطالع خواهد داد‪** .‬‬
‫پس از بازگشت کاربر از مراحل پرداخت سرویس اقساطی اسنپ‌پی‪ ،‬در صورتی که نتیجٔه اعالم شده به آدرس‬
‫بازگشتی پذیرنده موفق باشد اما به هر دلیل امکان ارائٔه خدمات به مشتری وجود نداشته باشد (به عنوان مثال‬
‫اتمام موجودی محصول خریداری شده در انبار و مواردی از این دست) باید سرویس ‪ revert‬توسط پذیرنده‬
‫فراخوانی گردد تا مبلغی که از حساب کاربر کسر شده بازگشت داده شود‪ .‬بدیهی است امکان انجام ‪ revert‬برای‬
‫تراکنشی که به وضعیت ‪ settle‬رسیده باشد وجود ندارد‪.‬‬

‫‪Post: /api/online/payment/v1/revert‬‬
‫نمونٔه درخواست‪:‬‬

‫‪"paymentToken": "string",‬‬

‫{‬
‫}‬

‫نمونٔه پاسخ‪:‬‬

‫{ ‪"response":‬‬

‫"‪"transactionId": "string‬‬

‫‪},‬‬

‫‪"successful": true‬‬

‫{‬
‫​‬

‫}‬

Get Payment Status ‫درخواست‬
.‫ می‌توانید از سرویس زیر استفاده کنید‬،‫برای استعالم وضعیت یک درخواست پرداخت در هر یک از مراحل قبل‬

Get: /api/online/payment/v1/status?paymentToken=[payment_token]
:‫نمونٔه پاسخ‬
{
​

"response": {

"transactionId": "string",

"status": "string",
},

}

"amount" : 0

"successful": true

‫درخواست ‪Cancel‬‬
‫چنانچه پس از اتمام کل فرآیند خرید و قرار‌گرفتن تراکنش در وضعیت ‪ settle‬نیاز به لغو آن بود‪ ،‬می‌توانید با‬
‫فراخوانی سرویس ‪ cancel‬تراکنش را لغو کنید‪.‬‬

‫‪Post: /api/online/payment/v1/cancel‬‬
‫نمونٔه درخواست‪:‬‬

‫‪"paymentToken": "string",‬‬

‫{‬
‫}‬

‫نمونٔه پاسخ‪:‬‬

‫{ ‪"response":‬‬

‫"‪"transactionId": "string‬‬

‫‪},‬‬

‫‪"successful": true‬‬

‫{‬
‫​‬

‫}‬

‫درخواست ‪Update‬‬
‫چنانچه پس از اتمام کل فرآیند خرید و قرار گرفتن تراکنش در وضعیت ‪ settle‬نیاز به تغییر در مبلغ و یا آیتم‌های‬
‫موجود در سبد خرید بود‪ ،‬این درخواست توسط سرویس ‪ update‬ارسال و پردازش می‌شود‪ .‬بدیهی است با توجه‬
‫به این نکته که کاربر در طی روند خرید اقساطی با مراجعه به درگاه بانکی قسط اول خود را پرداخت کرده‌است‪،‬‬
‫عملیات ‪ update‬باید با مبلغی کمتر از مبلغ اولیه صورت گیرد‪.‬‬
‫**دقت کنید که در درخواست ‪ update‬اگر یک محصول کامال حذف می‌شود‪ ،‬الزم است از بین کارت آیتم‌ها نیز‬
‫حذف شود‪.‬‬

‫‪Post: /api/online/payment/v1/update‬‬
‫نمونٔه درخواست‪:‬‬
‫​{‬

‫​‪"amount": 0,‬‬
‫​[ ‪"cartList":‬‬
‫​{‬

‫​‪"cartId": 0,‬‬

‫​[ ‪"cartItems":‬‬
‫​{‬

‫​‪"amount": 0,‬‬

‫​‪"category": "string",‬‬
‫​‪"count": 0,‬‬
‫​‪"id": 0,‬‬

‫‪"name": "string",‬‬

‫​‪"commissionType": 0‬‬

‫​}‬

‫​‪],‬‬

‫​‪"isShipmentIncluded": true,‬‬
‫​‪"isTaxIncluded": true,‬‬
‫​‪"shippingAmount": 0,‬‬
‫​‪"taxAmount": 0,‬‬

‫​‪"totalAmount": 0‬‬

‫​}‬

],​

"discountAmount": 0,

"externalSourceAmount": 0,​

"paymentMethodTypeDto": "INSTALLMENT",​
}

"paymentToken": "string"​

Property name

Mandatory

Note

Possible values

amount

true

Total amount of purchase

Currency: IRR

discountAmount

true

Currency: IRR

externalSourceAmount

true

Currency: IRR

paymentMethodTypeDto

true

INSTALLMENT

paymentToken

true

cartList

true

cartList - cardId

true

cartList -

true

cartList - isTaxIncluded

true

cartList - shippingAmount

true

Shipping amount of cart

Currency: IRR

cartList - taxAmount

true

Tax amount of cart

Currency: IRR

cartList - totalAmount

true

Total amount of cart

Currency: IRR

cartItems

true

cartItems - id

true

cartItems - amount

true

cartItems - category

true

cartItems - count

true

cartItems - name

true

isShipmentIncluded

Unique token of the
payment

Cart identifier

Cart item identifier
Currency: IRR

1,2,3,...

cartItems - commissionType

true

1,2,3,...

:‫نمونٔه پاسخ‬
{
​

}

"response": {
},

"transactionId": "string"

"successful": true

‫سواالت متداول در پیاده سازی‬
‫در این بخش خطا‌های متداول بر اساس هر مرحله و ارور کد به همراه استاتوس کد توضیح داده شده است‪ .‬در‬
‫کنار توضیحات هر خطا‪ ،‬راه حل برای رفع مشکل هم به صورت کامل قابل مشاهده است‪ .‬در صورتی که در هر‬
‫مرحله با وجود انجام راه‌حل‌های پیشنهادی همچنان مشکل وجود داشت‪ ،‬برای بررسی بیشتر آن‪ curl ،‬مربوط به‬
‫آن درخواست را برای پشتیبانی اسنپ پی ارسال فرمایید‪.‬‬
‫خطاهای مرحله " مکانیزم امن سازی درخواست‌ها" و روش حل آن‌ها‪:‬‬
‫‪ .​1‬خطای ‪Access Denied‬‬
‫معموال این خطا به دلیل وایت نبودن آی پی ایجاد می‌شود و برای رفع آن الزم است آی پی درست را‬
‫جهت وایت شدن ارسال فرمایید‪​ .‬‬
‫​‬

‫​‬
‫‪.​2‬‬

‫خطای ‪Unauthorized‬‬
‫این خطا به دلیل درست نبودن اطالعات دسترسی در قسمت ‪ Authorization‬که از انکد اشتباه ‪Client‬‬
‫‪ ID‬و ‪ Client Secret‬می باشد‪ ،‬به وجود می‌آید‪ .‬شما می‌توانید فرآیند انکد ‪ Client ID‬و ‪ Client Secret‬و‬
‫اطالعات ‪ Username‬و ‪ Password‬را مجددا بر اساس بخش «مکانیزم امن سازی درخواست‌ها» بررسی‬
‫کنید‪ .‬برای حصول اطمینان بهتر است متد درخواست و آدرس آن را هم بررسی کنید‪.‬‬

‫چطور می‌توانم ‪API‬های پیاده‌سازی شده را تست کنم؟‬
‫برای تست ‪ API‬و جلوگیری از به وجود آمدن خطا می‌توانید از کالکشن‌های ‪ Postman‬که توسط اسنپ پی تهیه‬
‫شده است استفاده کنید‪( .‬جهت دسترسی به لینک کالکشن بر روی این لینک کلیک کنید‪).‬‬
‫آیا نمونه کد برای تسریع فرآیند پیاده‌سازی وجود دارد؟‬
‫بله‪ ،‬برای رفع نیاز و سریعتر شدن فرآیند پیاده سازی سمپل کدهایی برای زبان های برنامه نویسی سمت بکند از‬
‫جمله ‪ php، .Net‬و ‪ ...‬در نظر گرفته شده است ‪ .‬جهت دانلود و استفاده از سمپل کدها از این لینک اقدام‬
‫فرمایید‪.‬‬
‫نمونه موفق برای ‪ access token‬به چه شکل است؟‬
‫در ابتدا دقت فرمایید که اکسس توکن (‪ ) jwt‬دارای زمان انقضاء به مدت ‪ 3600‬ثانیه است‪ .‬بنابراین الزم است که‬
‫‪ access token‬در حافظه کش نشود و منقضی شود‪ ،‬تا برای ادامه فرآیند خطای دسترسی دریافت نکنید‪​ .‬‬
‫​‬

‫روش پرداخت اسنپ‌پی به چه صورت در سایت باید نمایش داده شود؟‬
‫از موارد بسیار مهم که باید به صورت دقیق پیاده سازی گردد‪ ،‬نحوه نمایش روش پرداخت اسنپ پی است‪ .‬برای‬
‫این امر گایدالینی در نظر گرفته شده است که می توانید از این لینک آن را دریافت کنید‪.‬‬
‫‪ .​1‬با توجه به گایدالین‪ ،‬در خط اول تایتل (‪ )title‬و در خط بعدی دیسکریپشن (‪ )description‬باید نمایش‬
‫داده شود‪ .‬الزم بذکر است که یکی از موارد بسیار مهم نحوه نمایش درست و صحیح روش پرداخت‬
‫اقساطی اسنپ پی در نسخه موبایل است‪.‬‬
‫‪ .​2‬برای نمایش روش پرداخت اقساطی اسنپ پی باید سرویس ‪ eligible‬دقیقا ً مانند مستندات پیاده سازی‬
‫شود‪ .‬در صورت ‪ ture‬بودن‪ ،‬تایتل و دیسکریپشن که در جواب بازگردانده می شود بدون هیچگونه‬
‫تغییری نمایش داده شود و اگر جواب برگشتی ‪ false‬بود روش پرداخت اقساطی اسنپ پی نمایش داده‬
‫نشود‪.‬‬

‫‪ .​3‬از هر گونه پیاده سازی دستی در سمت خود خودداری فرمایید و حتما سرویس ‪ eligible‬را به درستی‬
‫پیاده سازی فرمایید‪.‬‬
‫‪ .​4‬برای مبالغ پایین ‪ ۴‬هزار تومان و باالی ‪ ۱۰‬میلیون تومان سرویس باید جواب ‪ False‬برگشت داده و به‬
‫هیچ عنوان روش پرداخت اسنپ پی نباید نمایش داده شود‪( .‬این اعداد برای محیط تست و استیجینگ‬
‫می‌باشد و در محیط پروداکشن متفاوت است‪).‬‬
‫‪ .​5‬پارامترهای عنوان (‪ )title‬و توضیحات (‪ )description‬که پارامترهای برگشتی از درخواست سرویس‬
‫‪ eligible‬هستند همیشه داینامیک از سمت اسنپ پی بوده و به هیچ عنوان نباید به صورت ثابت از‬
‫سمت مرچنت نمایش پیدا کند‪.‬‬
‫‪ .​6‬با توجه به داینامیک بودن سرویس ‪ ،eligible‬باید با هر تغییری در پارامتر ‪ amount‬اصلی‪ ،‬سرویس‬
‫‪ eligible‬فراخوانی شده و نسبت به جواب برگشت داده شده روش پرداختی نمایش یا عدم نمایش را‬
‫داشته باشد‪.‬‬

‫فرآیند کلی اتصال به اسنپ‌پی به چه شکل است؟‬
‫در ابتدا برای پیاده سازی و در ادامه تست فرآیند یک دسترسی استیج داده خواهد شد‪ .‬بعد از تایید پیاده سازی‬
‫درست و صحیح که در جلسات ‪ pre-demo‬و دمو توسط کارشناسان فنی اسنپ پی مورد بررسی قرار می‌گیرد‪،‬‬
‫دسترسی محیط اصلی و پروداکشن برای شما ارسال خواهد شد‪.‬‬

‫فهرست خطاها‬
‫از طریق این لیست می‌توانید لیست خطاها را به همراه دالیل رخ‌داد خطا و نحوه تغییر را به صورت کامل دریافت‬
‫کنید‪.‬‬

‫ضمیمه (نمودار روند فرآیند خرید)‬

