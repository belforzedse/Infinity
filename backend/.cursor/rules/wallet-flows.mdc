---
alwaysApply: false
description: Backend wallet top-up via Mellat and wallet checkout payment flow
---

## Backend Wallet Flows

- Wallet balances and transactions are tracked in Strapi models. For IRR amounts, wallet storage uses IRR.
- New wallet top-up content type persists pending top-ups and gateway references.

### Wallet Top-up (Mellat)

- Content type schema: [src/api/wallet-topup/content-types/wallet-topup/schema.json](mdc:infinity-store-backend/src/api/wallet-topup/content-types/wallet-topup/schema.json)
- Controller: [src/api/wallet-topup/controllers/wallet-topup.ts](mdc:infinity-store-backend/src/api/wallet-topup/controllers/wallet-topup.ts)
- Routes:
  - POST `/api/wallet/charge-intent` → creates `wallet-topup` (Status=Pending), calls Mellat V3, returns `redirectUrl`, `refId`.
  - POST `/api/wallet/payment-callback` → verifies and settles via Mellat V3, updates top-up, credits wallet, creates `local-user-wallet-transaction` Type="Add", then redirects to FE `https://infinity.rgbgroup.ir/wallet?status=...`.
- Callback base uses production API domain: `https://api.infinity.rgbgroup.ir/api/wallet/payment-callback`.

### Checkout with Wallet Payment (Full Wallet Only)

- Implementation in finalize-to-order handler: [src/api/cart/controllers/handlers/finalizeToOrder.ts](mdc:infinity-store-backend/src/api/cart/controllers/handlers/finalizeToOrder.ts)
- Behavior when `gateway === "wallet"`:
  - Computes total in IRR from contract amount (toman → IRR).
  - Validates wallet balance ≥ required IRR; else returns 400 with `insufficient_wallet`.
  - Deducts wallet balance; creates `local-user-wallet-transaction` Type="Minus" with `ReferenceId` = order id.
  - Decrements stock post-payment; sets order `Status="Started"`.
  - Writes `order-log` entry: "Wallet payment success".
  - Returns success without external redirect.

### Notes

- Units: IRR for wallet persistence. Contract amounts are in toman; convert toman × 10 to IRR for wallet operations.
- Cart clearing follows existing policy (no change here) and is handled elsewhere on successful payment flows.
